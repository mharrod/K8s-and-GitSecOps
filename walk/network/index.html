
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="GitSecOps for K8s">
      
      
        <meta name="author" content="Martin Harrod">
      
      
        <link rel="canonical" href="https://mharrod.github.io/k8s-and-GitSecOps/walk/network/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.11">
    
    
      
        <title>4.Networking and Environments - K8s and GitSecOps</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.8c5ef100.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.9647289d.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.css">
    
      <link rel="stylesheet" href="../../assets/stylesheets/footer.css">
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="harma" data-md-color-accent="harma">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#4networking-and-environments" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="K8s and GitSecOps" class="md-header__button md-logo" aria-label="K8s and GitSecOps" data-md-component="logo">
      
  <img src="../../assets/images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            K8s and GitSecOps
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              4.Networking and Environments
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="harma" data-md-color-accent="harma"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="harma" data-md-color-accent="harma"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/mharrod/K8s-and-GitSecOps" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitSecOps/docs
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      Start
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../crawl/" class="md-tabs__link">
        Crawl
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../" class="md-tabs__link md-tabs__link--active">
        Walk
      </a>
    </li>
  

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../run/" class="md-tabs__link">
      Run(WIP)
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../fly/" class="md-tabs__link">
      Fly(WIP)
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../capstone/" class="md-tabs__link">
      Capstone
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../explorations/" class="md-tabs__link">
        Explorations
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="K8s and GitSecOps" class="md-nav__button md-logo" aria-label="K8s and GitSecOps" data-md-component="logo">
      
  <img src="../../assets/images/logo.png" alt="logo">

    </a>
    K8s and GitSecOps
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/mharrod/K8s-and-GitSecOps" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitSecOps/docs
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Start
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../crawl/">Crawl</a>
          
            <label for="__nav_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Crawl" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Crawl
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crawl/local/" class="md-nav__link">
        1.Local Application
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crawl/published/" class="md-nav__link">
        2.Containerized Application
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crawl/scratch/" class="md-nav__link">
        3.Image From Scratch
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crawl/sign/" class="md-nav__link">
        4.Image Signing
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../">Walk</a>
          
            <label for="__nav_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Walk" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Walk
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes/" class="md-nav__link">
        1.K8s, Kind and Security Scanning
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kaniko/" class="md-nav__link">
        2.Build Images with Kaniko
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../verification/" class="md-nav__link">
        3.Image Verification in K8s
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          4.Networking and Environments
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        4.Networking and Environments
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#supplementary-learning-material" class="md-nav__link">
    Supplementary Learning material
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scenario" class="md-nav__link">
    Scenario
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../run/" class="md-nav__link">
        Run(WIP)
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../fly/" class="md-nav__link">
        Fly(WIP)
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../capstone/" class="md-nav__link">
        Capstone
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      
      
        
          
            
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../explorations/">Explorations</a>
          
            <label for="__nav_7">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Explorations" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Explorations
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../explorations/proposal/" class="md-nav__link">
        Proposal Template
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#supplementary-learning-material" class="md-nav__link">
    Supplementary Learning material
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scenario" class="md-nav__link">
    Scenario
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<h1 id="4networking-and-environments">4.Networking and Environments<a class="headerlink" href="#4networking-and-environments" title="Permanent link">&para;</a></h1>
<p>The software deployment process involves different environments with different purposes, ranging from local development to production release. The CI/CD process involves promoting code changes through the Dev, QA, Stage, and Prod environments, each of which has its own testing and configuration requirements. The goal is to ensure that code changes are thoroughly tested in preproduction environments before being released to production, where they can impact actual customers.</p>
<p>Kubernetes can be used to manage the deployment of applications across different environments by creating separate namespaces for each environment. For example, you can create a namespace for "development", another for "stage", and another for "production". Then you can create deployment objects, service objects, and other Kubernetes resources within each namespace to represent the application components.</p>
<p>In this scenario, we are going to create two clusters.  One cluster will be for preprod (QA and security testing) and another cluster for stage and production.  We will then experiment with how we can create separation for these environments and leverage Kyverno to enforce network policies.</p>
<h2 id="supplementary-learning-material">Supplementary Learning material<a class="headerlink" href="#supplementary-learning-material" title="Permanent link">&para;</a></h2>
<iframe width="1120" height="630" src="https://www.youtube.com/embed/RP-jSB2eclk" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>

<p>Additional Links:</p>
<ul>
<li><strong>Gitops and Kubernetes Chapter 3</strong> - <a href="https://www.manning.com/books/gitops-and-kubernetes">https://www.manning.com/books/gitops-and-kubernetes</a></li>
<li><strong>Calico and Network Policy</strong> - <a href="https://projectcalico.docs.tigera.io/security/kubernetes-network-policy">https://projectcalico.docs.tigera.io/security/kubernetes-network-policy</a></li>
<li><strong>Redhat K8s Network Policy</strong> - <a href="https://cloud.redhat.com/blog/guide-to-kubernetes-egress-network-policies">https://cloud.redhat.com/blog/guide-to-kubernetes-egress-network-policies</a></li>
<li><strong>Calico k8s Policy basics</strong> - <a href="https://docs.projectcalico.org/security/tutorials/kubernetes-policy-basic">https://docs.projectcalico.org/security/tutorials/kubernetes-policy-basic</a></li>
<li><strong>K8s Network Policy</strong> - <a href="https://kubernetes.io/docs/concepts/services-networking/network-policies/">https://kubernetes.io/docs/concepts/services-networking/network-policies/</a></li>
</ul>
<h2 id="scenario">Scenario<a class="headerlink" href="#scenario" title="Permanent link">&para;</a></h2>
<p>Kind (as with minikube and most other local Kubernetes environments) uses kindnetd as the default for the CNI.  This CNI is too basic to complete the network policy exercise in the chapter.  As a result, we will install Calico as our CNI.  If you notice in the configuration files above, we set disableDefaultCNI: true.  This setting ensured that the default CNI was not installed and that we could layer on our own. See the following link if you want to better understand CNI https://www.tigera.io/learn/guides/kubernetes-networking/kubernetes-cni</p>
<ol>
<li>Deploy a cluster named prepod witj Calico CNI installed </li>
<li>Switch to prepod cluster and create environment Namespaces qa and sectest.</li>
<li>Deploy a Curl application  to both QA and sectest </li>
<li>Deploy an NGNix webserver in QA</li>
<li>try to curl from both qa and sectest</li>
<li>Apply a netwrok policy to prevent all pods outside qa from accessing qa</li>
<li>Try to curl NGNIX webserver from each environment (sectest fails and qa passes)</li>
<li>Switch to Prod Cluster and Install Calico </li>
<li>Install Kyverno and apply default deny-all policy to all namespaces created </li>
<li>Set-up environment as above (using stage and prod namespace)</li>
<li>Try to curl from both stage and prod (should both fail)</li>
<li>Create network policies to permit accessing web server in prod from stage</li>
<li>Try to curl from both stage and prod (stage fails and prod works)</li>
<li>Destroy environment </li>
</ol>
<details class="harma">
<summary>kubetx and kubens</summary>
<div class="highlight"><pre><span></span><code>Kubetx and Kubens make interacting with multiple clusters and namespaces easier. There are ways to do this with kubectl, but these tools/plugins make it easier.  The two tools are:

1. **Kubectx** - kubectx is a tool to switch between contexts (clusters) on kubectl faster
2. **kubens** - is a tool to switch between Kubernetes namespaces (and configure them for kubectl) easily

Here is the link to the git repo https://github.com/ahmetb/kubectx

There are many ways to install these tools(depending on if you want auto-complete etc.).  For this walkthrough, we keep  it simple and do the following;

```
$ wget https://raw.githubusercontent.com/ahmetb/kubectx/master/kubectx
$ wget https://raw.githubusercontent.com/ahmetb/kubectx/master/kubens
$ chmod +x kubectx kubens
$ sudo mv kubens kubectx /usr/local/bin
```
</code></pre></div>
</details>
<details class="harma">
<summary>Solution</summary>
<p>1.O Deploy a cluster named prepod and a cluster named prod with Calico CNI installed</p>
<p>1.1 Create First Cluster </p>
<p>Here is the configuration file for the first cluster </p>
<div class="highlight"><pre><span></span><code>cat &lt;&lt;EOF | kind create cluster --name preprod --config=-
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
  - role: control-plane
  - role: worker
networking:
  podSubnet: 10.240.0.0/16
  serviceSubnet: 10.110.0.0/16
  disableDefaultCNI: true
EOF
</code></pre></div>
<p>1.2 Create Second Cluster </p>
<p>Here is the configuration for the second cluster 
 <div class="highlight"><pre><span></span><code>cat &lt;&lt;EOF | kind create cluster --name prod --config=-
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
  - role: control-plane
  - role: worker
networking:
  podSubnet: 10.241.0.0/16
  serviceSubnet: 10.111.0.0/16
  disableDefaultCNI: true
EOF
</code></pre></div></p>
<p>1.3 Review and make sure the clusters are set up correctly</p>
<div class="highlight"><pre><span></span><code>$ kind get clusters
</code></pre></div>
<p>1.4  Make sure you are on the preprod cluster </p>
<div class="highlight"><pre><span></span><code>kubectx kind-preprod
</code></pre></div>
<p>1.5 install the Tigera operator on the cluster.</p>
<div class="highlight"><pre><span></span><code>$ kubectl create -f https://docs.projectcalico.org/manifests/tigera-operator.yaml
</code></pre></div>
<p>1.6 Apply the configuration</p>
<div class="highlight"><pre><span></span><code>kubectl apply -f - &lt;&lt;EOF
apiVersion: operator.tigera.io/v1
kind: Installation
metadata:
  name: default
spec:
  calicoNetwork:
    ipPools:
      - blockSize: 26
        cidr: 10.240.0.0/16
        encapsulation: VXLANCrossSubnet
        natOutgoing: EnabledInstall Kyverno and apply dedault deny-all policy to all namespaces created 
</code></pre></div>
<p>1.7 Verify installation 
 We may verify the installation of Calico by listing running pods in the calico-system namespace. Below is a sample result.  Please note, it can take several minutes (i have seen as long as ten) for kubernetes to actual apply and get Calico up and running.</p>
<div class="highlight"><pre><span></span><code>kubectl get pod -n calico-system
NAME                                       READY   STATUS    RESTARTS   AGE
calico-kube-controllers-777bf44dbc-6x4lc   1/1     Running   0          25m
calico-node-5pmzw                          1/1     Running   0          25m
calico-node-jnmrx                          1/1     Running   0          25m
calico-typha-59747bfc5-zgmlk               1/1     Running   0          25m
csi-node-driver-74wg4                      2/2     Running   0          12m
csi-node-driver-gszqh                      2/2     Running   0          15m
</code></pre></div>
<p>2.0 Switch to prepod cluster and create environment Namespaces qa and sectest.</p>
<p>2.1 Make sure we are on the preprod cluster 
 <div class="highlight"><pre><span></span><code>kubectx kind-preprod
</code></pre></div></p>
<p>2.2 Create environment Namespaces (qa and prod)</p>
<div class="highlight"><pre><span></span><code>$ kubectl create namespace qa
$ kubectl create namespace sectest
$ kubectl get namespaces
</code></pre></div>
<p>3.0 Deploy curl to the qa and sectest Namespaces</p>
<div class="highlight"><pre><span></span><code>kubectl apply -f - &lt;&lt;EOF
apiVersion: v1
kind: Pod
metadata:
  name: curl-pod
  namespace: qa
spec:
  containers:
  - name: curlpod
    image: radial/busyboxplus:curl
    command:
    - sh
    - -c
    - while true; do sleep 1; done  
---
apiVersion: v1
kind: Pod
metadata:
  name: curl-pod
  namespace: sectest
spec:
  containers:
  - name: curlpod
    image: radial/busyboxplus:curl
    command:
    - sh
    - -c
    - while true; do sleep 1; done  
EOF
</code></pre></div>
<p>4.0  Deploy an NGNIXwebserver in QA</p>
<p>4.1 Deploy server
<div class="highlight"><pre><span></span><code> kubectl apply -n qa -f - &lt;&lt;EOF
 apiVersion: v1
 kind: Pod
 metadata:
   name: web
 spec:
   containers:
   - image: nginx
     imagePullPolicy: Always
     name: nginx
     ports:
     - containerPort: 80
       protocol: TCP
 EOF
</code></pre></div></p>
<p>4.2 Get the IP address of the web pod in the prod namespace </p>
<div class="highlight"><pre><span></span><code>$ kubectl describe pod web -n qa | grep IP 
$ export WEB_IP_QA = &lt;IP from above&gt;
</code></pre></div>
<p>5.0 try to curl from both qa and sectest </p>
<div class="highlight"><pre><span></span><code>$ kubectl -n sectest  exec curl-pod -- curl --max-time 5.5 -I $WEB_IP_QA
$ kubectl -n qa  exec curl-pod -- curl --max-time 5.5 -I $WEB_IP_QA
</code></pre></div>
<p>6.0 Apply a network policy to prevent all pods outside qa from accessing qa</p>
<div class="highlight"><pre><span></span><code>kubectl apply -n qa -f - &lt;&lt;EOF
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  namespace: qa              
  name: block-other-namespace
spec:
  podSelector: {}               
  ingress:
  - from:
    - podSelector: {}     
EOF
</code></pre></div>
<p>7.0 Try to curl NGNIX webserver from each environment (sectest fails and qa passes)</p>
<div class="highlight"><pre><span></span><code>$ kubectl -n sectest  exec curl-pod -- curl --max-time 5.5 -I $WEB_IP
$ kubectl -n qa  exec curl-pod -- curl --max-time 5.5 -I $WEB_IP
</code></pre></div>
<p>8.0  Switch to Prod Cluster and Install Calico </p>
<p>8.1 - Make sure we are on the prod cluster</p>
<div class="highlight"><pre><span></span><code>kubectx kind-prod
</code></pre></div>
<p>8.2 install the Tigera operator on the cluster.</p>
<div class="highlight"><pre><span></span><code>$ kubectl create -f https://docs.projectcalico.org/manifests/tigera-operator.yaml
</code></pre></div>
<p>8.3 Check calico
 <div class="highlight"><pre><span></span><code>kubectl get pod -n calico-system
</code></pre></div></p>
<p>8.3 Apply the configuration</p>
<div class="highlight"><pre><span></span><code>kubectl apply -f - &lt;&lt;EOF
apiVersion: operator.tigera.io/v1
kind: Installation
metadata:
  name: default
spec:
  calicoNetwork:
    ipPools:
      - blockSize: 26
        cidr: 10.241.0.0/16
        encapsulation: VXLANCrossSubnet
        natOutgoing: Enabled
        nodeSelector: all()
EOF
</code></pre></div>
<p>9.0 Install Kyverno and apply dedault deny-all policy to all namespaces created </p>
<p>9.1 Install Kyverno (Note this is a cluster wide policy )</p>
<div class="highlight"><pre><span></span><code> helm install kyverno kyverno/kyverno -n kyverno --create-namespace
</code></pre></div>
<p>9.2 apply kyverno policy
 <div class="highlight"><pre><span></span><code>kubectl apply  -f - &lt;&lt;EOF
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: add-networkpolicy
  annotations:
    policies.kyverno.io/title: Add Network Policy
    policies.kyverno.io/category: Multi-Tenancy, EKS Best Practices
    policies.kyverno.io/subject: NetworkPolicy
    policies.kyverno.io/minversion: 1.6.0
    policies.kyverno.io/description: &gt;-
      By default, Kubernetes allows communications across all Pods within a cluster.
      The NetworkPolicy resource and a CNI plug-in that supports NetworkPolicy must be used to restrict
      communications. A default NetworkPolicy should be configured for each Namespace to
      default deny all ingress and egress traffic to the Pods in the Namespace. Application
      teams can then configure additional NetworkPolicy resources to allow desired traffic
      to application Pods from select sources. This policy will create a new NetworkPolicy resource
      named `default-deny` which will deny all traffic anytime a new Namespace is created.      
spec:
  rules:
  - name: default-deny
    match:
      any:
      - resources:
          kinds:
          - Namespace
    generate:
      apiVersion: networking.k8s.io/v1
      kind: NetworkPolicy
      name: default-deny
      namespace: &quot;{{request.object.metadata.name}}&quot;
      synchronize: true
      data:
        spec:
          # select all pods in the namespace
          podSelector: {}
          # deny all traffic
          policyTypes:
          - Ingress
          - Egress
EOF
</code></pre></div></p>
<p>10.0  Set-up environment as above (using stage and prod namespace)</p>
<p>10.1 Make e we are on the prepod cluster </p>
<div class="highlight"><pre><span></span><code>kubectx kind-prod
</code></pre></div>
<p>10.2 Create environment Namespaces (qa and prod)</p>
<div class="highlight"><pre><span></span><code>$ kubectl create namespace stage
$ kubectl create namespace prod
$ kubectl get namespaces
</code></pre></div>
<p>10.3 Deploy curl to the qa and sectest Namespaces</p>
<div class="highlight"><pre><span></span><code>kubectl apply -f - &lt;&lt;EOF
apiVersion: v1
kind: Pod
metadata:
  name: curl-pod
  namespace: stage
spec:
  containers:
  - name: curlpod
    image: radial/busyboxplus:curl
    command:
    - sh
    - -c
    - while true; do sleep 1; done  
---
apiVersion: v1
kind: Pod
metadata:
  name: curl-pod
  namespace: prod
spec:
  containers:
  - name: curlpod
    image: radial/busyboxplus:curl
    command:
    - sh
    - -c
    - while true; do sleep 1; done  
EOF
</code></pre></div>
<p>10.4  Deploy an NGNIX webserver in prod</p>
<div class="highlight"><pre><span></span><code> kubectl apply -n prod -f - &lt;&lt;EOF
 apiVersion: v1
 kind: Pod
 metadata:
   name: web
 spec:
   containers:
   - image: nginx
     imagePullPolicy: Always
     name: nginx
     ports:
     - containerPort: 80
       protocol: TCP
 EOF
</code></pre></div>
<p>11.0 Try to curl from both stage and prod (should both fail)</p>
<p>11.1 Get Web IP</p>
<div class="highlight"><pre><span></span><code>$ kubectl describe pod web -n prod | grep IP 
$ export WEB_IP_PROD = &lt;IP from above&gt;
</code></pre></div>
<p>11.2 try to curl from both qa and sectest 
<div class="highlight"><pre><span></span><code> $ kubectl -n stage  exec curl-pod -- curl --max-time 5.5 -I $WEB_IP_PROD
 $ kubectl -n prod  exec curl-pod -- curl --max-time 5.5 -I $WEB_IP_PROD
</code></pre></div></p>
<p>12.0 Create network policies to permit accessing web server in prod from prod</p>
<div class="highlight"><pre><span></span><code> kubectl apply  -f - &lt;&lt;EOF
 apiVersion: networking.k8s.io/v1
 kind: NetworkPolicy
 metadata:
   namespace: prod              
   name: allow-ingress-prod
 spec:
   podSelector: {}               
   ingress:
   - from:
     - podSelector: {} 
 ---
 apiVersion: networking.k8s.io/v1
 kind: NetworkPolicy
 metadata:
   namespace: prod  
   name: allow-all-egress
 spec:
   podSelector: {}
   egress:
   - {}
   policyTypes:
   - Egress
 EOF
</code></pre></div>
<p>13.0 Try to curl from both stage and prod (stage fails and prod works)</p>
<p>13.1 Get IP Address
 <div class="highlight"><pre><span></span><code>$ kubectl describe pod web -n prod | grep IP 
$ export WEB_IP = &lt;IP from above&gt;
</code></pre></div></p>
<p>13.2  from both qa and sectest 
<div class="highlight"><pre><span></span><code> $ kubectl -n stage  exec curl-pod -- curl --max-time 5.5 -I $WEB_IP_PROD
 $ kubectl -n prod  exec curl-pod -- curl --max-time 5.5 -I $WEB_IP_PROD
</code></pre></div></p>
<p>14.0 Destroy environment </p>
<div class="highlight"><pre><span></span><code>$ Kubectx prod
$ kubectl delete namespace prod
$ Kubectl delete namespace stage
$ Kind delete clusters prod 

$ Kubectx preprod
$ kubectl delete namespace qa
$ kubectl delete namespace sectest


$ kind delete clusters --all  
</code></pre></div>
</details>
<h1 id="additional-challenges">Additional Challenges<a class="headerlink" href="#additional-challenges" title="Permanent link">&para;</a></h1>
<ul>
<li><strong>Kyverno</strong> - In the prod cluster create stage and prod namespaces </li>
<li><strong>Practice kubernetes stuff</strong> - 4. Deploy the Kubernetes guestbook application to the qa and sectest environment.</li>
</ul>

  <hr>
<div class="md-source-file">
  <small>
    
      Last update:
      <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">January 31, 2023</span>
      
    
  </small>
</div>

              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../verification/" class="md-footer__link md-footer__link--prev" aria-label="Previous: 3.Image Verification in K8s" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              3.Image Verification in K8s
            </div>
          </div>
        </a>
      
      
        
        <a href="../../run/" class="md-footer__link md-footer__link--next" aria-label="Next: Run(WIP)" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Run(WIP)
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      © Copyright Martin Harrod
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://discord.com" target="_blank" rel="noopener" title="discord.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M524.531 69.836a1.5 1.5 0 0 0-.764-.7A485.065 485.065 0 0 0 404.081 32.03a1.816 1.816 0 0 0-1.923.91 337.461 337.461 0 0 0-14.9 30.6 447.848 447.848 0 0 0-134.426 0 309.541 309.541 0 0 0-15.135-30.6 1.89 1.89 0 0 0-1.924-.91 483.689 483.689 0 0 0-119.688 37.107 1.712 1.712 0 0 0-.788.676C39.068 183.651 18.186 294.69 28.43 404.354a2.016 2.016 0 0 0 .765 1.375 487.666 487.666 0 0 0 146.825 74.189 1.9 1.9 0 0 0 2.063-.676A348.2 348.2 0 0 0 208.12 430.4a1.86 1.86 0 0 0-1.019-2.588 321.173 321.173 0 0 1-45.868-21.853 1.885 1.885 0 0 1-.185-3.126 251.047 251.047 0 0 0 9.109-7.137 1.819 1.819 0 0 1 1.9-.256c96.229 43.917 200.41 43.917 295.5 0a1.812 1.812 0 0 1 1.924.233 234.533 234.533 0 0 0 9.132 7.16 1.884 1.884 0 0 1-.162 3.126 301.407 301.407 0 0 1-45.89 21.83 1.875 1.875 0 0 0-1 2.611 391.055 391.055 0 0 0 30.014 48.815 1.864 1.864 0 0 0 2.063.7A486.048 486.048 0 0 0 610.7 405.729a1.882 1.882 0 0 0 .765-1.352c12.264-126.783-20.532-236.912-86.934-334.541ZM222.491 337.58c-28.972 0-52.844-26.587-52.844-59.239s23.409-59.241 52.844-59.241c29.665 0 53.306 26.82 52.843 59.239 0 32.654-23.41 59.241-52.843 59.241Zm195.38 0c-28.971 0-52.843-26.587-52.843-59.239s23.409-59.241 52.843-59.241c29.667 0 53.307 26.82 52.844 59.239 0 32.654-23.177 59.241-52.844 59.241Z"/></svg>
    </a>
  
    
    
    <a href="mailto:<martin.harrod@proton.me>" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="m511.6 36.86-64 415.1a32.008 32.008 0 0 1-31.65 27.147c-4.188 0-8.319-.815-12.29-2.472l-122.6-51.1-50.86 76.29C226.3 508.5 219.8 512 212.8 512c-11.5 0-20.8-9.3-20.8-20.8v-96.18c0-7.115 2.372-14.03 6.742-19.64L416 96 122.3 360.3 19.69 317.5C8.438 312.8.812 302.2.062 289.1s5.47-23.72 16.06-29.77l448-255.1c10.69-6.109 23.88-5.547 34 1.406S513.5 24.72 511.6 36.86z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://linkedin.com" target="_blank" rel="noopener" title="linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.annotate", "content.tabs.link", "navigation.indexes", "navigation.sections", "navigation.tabs", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest"], "search": "../../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.748e2769.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/tablesort/5.2.1/tablesort.min.js"></script>
      
        <script src="../../assets/javascripts/tables.js"></script>
      
    
  </body>
</html>