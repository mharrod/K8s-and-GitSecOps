
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="GitSecOps for K8s">
      
      
        <meta name="author" content="Martin Harrod">
      
      
        <link rel="canonical" href="https://mharrod.github.io/k8s-and-GitSecOps/crawl/scratch/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.11">
    
    
      
        <title>3.Image From Scratch - K8s and GitSecOps</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.8c5ef100.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.9647289d.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.css">
    
      <link rel="stylesheet" href="../../assets/stylesheets/footer.css">
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="harma" data-md-color-accent="harma">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#3image-from-scratch" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="K8s and GitSecOps" class="md-header__button md-logo" aria-label="K8s and GitSecOps" data-md-component="logo">
      
  <img src="../../assets/images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            K8s and GitSecOps
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              3.Image From Scratch
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="harma" data-md-color-accent="harma"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="harma" data-md-color-accent="harma"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/mharrod/K8s-and-GitSecOps" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitSecOps/docs
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      Start
    </a>
  </li>

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../" class="md-tabs__link md-tabs__link--active">
        Crawl
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../walk/" class="md-tabs__link">
        Walk
      </a>
    </li>
  

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../run/" class="md-tabs__link">
      Run(WIP)
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../fly/" class="md-tabs__link">
      Fly(WIP)
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../capstone/" class="md-tabs__link">
      Capstone
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../explorations/" class="md-tabs__link">
        Explorations
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="K8s and GitSecOps" class="md-nav__button md-logo" aria-label="K8s and GitSecOps" data-md-component="logo">
      
  <img src="../../assets/images/logo.png" alt="logo">

    </a>
    K8s and GitSecOps
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/mharrod/K8s-and-GitSecOps" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitSecOps/docs
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Start
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../">Crawl</a>
          
            <label for="__nav_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Crawl" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Crawl
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../local/" class="md-nav__link">
        1.Local Application
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../published/" class="md-nav__link">
        2.Containerized Application
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          3.Image From Scratch
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        3.Image From Scratch
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    Introduction
  </a>
  
    <nav class="md-nav" aria-label="Introduction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#single-vs-multi-stage-image-building" class="md-nav__link">
    Single vs multi stage image building
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#supplementary-learning-material" class="md-nav__link">
    Supplementary Learning Material
  </a>
  
    <nav class="md-nav" aria-label="Supplementary Learning Material">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#additional-links" class="md-nav__link">
    Additional Links:
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scenario" class="md-nav__link">
    Scenario
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#additional-challenges" class="md-nav__link">
    Additional Challenges
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sign/" class="md-nav__link">
        4.Image Signing
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../walk/">Walk</a>
          
            <label for="__nav_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Walk" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Walk
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../walk/kubernetes/" class="md-nav__link">
        1.K8s, Kind and Security Scanning
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../walk/kaniko/" class="md-nav__link">
        2.Build Images with Kaniko
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../walk/cd/" class="md-nav__link">
        3.Declarative Continuous Delivery
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../walk/verification/" class="md-nav__link">
        4.Image Verification in K8s(WIP)
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../run/" class="md-nav__link">
        Run(WIP)
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../fly/" class="md-nav__link">
        Fly(WIP)
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../capstone/" class="md-nav__link">
        Capstone
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      
      
        
          
            
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../explorations/">Explorations</a>
          
            <label for="__nav_7">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Explorations" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Explorations
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../explorations/proposal/" class="md-nav__link">
        Proposal Template
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    Introduction
  </a>
  
    <nav class="md-nav" aria-label="Introduction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#single-vs-multi-stage-image-building" class="md-nav__link">
    Single vs multi stage image building
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#supplementary-learning-material" class="md-nav__link">
    Supplementary Learning Material
  </a>
  
    <nav class="md-nav" aria-label="Supplementary Learning Material">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#additional-links" class="md-nav__link">
    Additional Links:
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scenario" class="md-nav__link">
    Scenario
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#additional-challenges" class="md-nav__link">
    Additional Challenges
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<h1 id="3image-from-scratch">3.Image From Scratch<a class="headerlink" href="#3image-from-scratch" title="Permanent link">&para;</a></h1>
<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h2>
<p>This scenario assumes that you have completed the security verification practices in the last exercise set.  If you have not done this, you should ensure you complete these steps and understand the importance of inspecting an image before using it.  For this scenario, we will recreate an image container from scratch and push it to a container repository and then pull it for use locally. </p>
<p>There are several reasons why someone might want to build a Docker image from scratch:</p>
<details class="harma">
<summary>Customization</summary>
<p>Building a container image from scratch allows you to fully customize the contents of the image to meet your specific needs. You can include only the libraries, dependencies, and applications that you need, and configure the image in exactly the way that you want.   </p>
</details>
<details class="harma">
<summary>Size</summary>
<p>Building a container image from scratch can result in a smaller final image size, as you only include the components that you need and can optimize the image for your specific use case.</p>
</details>
<details class="harma">
<summary>Security</summary>
<p>Building a Container image from scratch allows you to start with a minimal base image and add only the components that you need, which can help to reduce the attack surface and improve security </p>
</details>
<details class="harma">
<summary>Control</summary>
<p>Building a Docker image from scratch gives you complete control over the contents and configuration of the image, which can be useful if you have specific requirements or constraints.</p>
</details>
<details class="harma">
<summary>Learning</summary>
<p>Building a Docker image from scratch can also be a useful learning exercise, as it allows you to understand the process of creating a Docker image and the various components that go into it. </p>
</details>
<h4 id="single-vs-multi-stage-image-building">Single vs multi stage image building<a class="headerlink" href="#single-vs-multi-stage-image-building" title="Permanent link">&para;</a></h4>
<p>We will also explore building single-stage and multistage container images.  A single-stage container build is a process in which all the necessary steps to create a container image are performed in a single build stage.  This can include building the application, installing dependencies, and packaging the final image.  On the other hand, a multistage container build involves creating the container image in multiple stages.  Each stage in the build process includes only the packages and libraries necessary for that stage rather than the entire build environment.  The final stage of the build process creates the final container image, which only includes the packages and libraries needed for the application.</p>
<p>There are several reasons why it can be beneficial to build containers in multiple stages:</p>
<details class="harma">
<summary>Smaller image size</summary>
<p>Building a container in multiple stages allows you to create smaller final images. This is because each stage in the build process only includes the packages and libraries necessary for that stage, rather than the entire build environment. This can make it easier to deploy and manage the container, as well as reduce the risk of security vulnerabilities.</p>
</details>
<details class="harma">
<summary>Improved Security</summary>
<p>Building a container in multiple stages can improve security by reducing the attack surface of the final image. This is because the final image only includes the packages and libraries necessary for the application, rather than the entire build environment.</p>
</details>
<details class="harma">
<summary>Simplified maintenance</summary>
<p>Building a container in multiple stages can make it easier to maintain the container over time. This is because you can update or rebuild individual stages of the build process without affecting the entire container.</p>
</details>
<details class="harma">
<summary>Improved build efficiency</summary>
<p>Building a container in multiple stages can improve build efficiency by allowing you to reuse common build steps across multiple containers. This can save time and reduce the complexity of the build process.</p>
</details>
<p>Overall, building containers in multiple stages can provide a number of benefits, including smaller image size, improved security, simplified maintenance, and improved build efficiency.</p>
<h2 id="supplementary-learning-material">Supplementary Learning Material<a class="headerlink" href="#supplementary-learning-material" title="Permanent link">&para;</a></h2>
<iframe width="1120" height="630" src="https://www.youtube.com/embed/JofsaZ3H1qM" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>

<h4 id="additional-links">Additional Links:<a class="headerlink" href="#additional-links" title="Permanent link">&para;</a></h4>
<ul>
<li>Podman for Devops Chapter 6 - <a href="https://learning.oreilly.com/library/view/podman-for-devops/9781803248233/B17908_06_epub.xhtml#_idParaDest-131">https://learning.oreilly.com/library/view/podman-for-devops/9781803248233/B17908_06_epub.xhtml#_idParaDest-131</a></li>
<li>
<p>Buildah as a cli tool - <a href="https://hackernoon.com/">https://hackernoon.com/</a></p>
</li>
<li>
<p>Getting started Buildah - &lt;(https://opensource.com/article/18/6/getting-started-buildah&gt;</p>
</li>
<li>Buildah and OCI Images - <a href="https://www.linode.com/docs/guides/using-buildah-oci-images/">https://www.linode.com/docs/guides/using-buildah-oci-images/</a></li>
<li>Github buildah tutorial - <a href="https://github.com/containers/buildah/blob/main/docs/tutorials/01-intro.md)">https://github.com/containers/buildah/blob/main/docs/tutorials/01-intro.md)</a> </li>
<li>Docker Multistage - <a href="https://docs.docker.com/build/building/multi-stage">https://docs.docker.com/build/building/multi-stage</a>  </li>
<li>Buildah vs Kaniko - <a href="https://earthly.dev/blog/docker-vs-buildah-vs-kaniko/">https://earthly.dev/blog/docker-vs-buildah-vs-kaniko/</a></li>
<li>Distroless - <a href="https://github.com/GoogleContainerTools/distroless">https://github.com/GoogleContainerTools/distroless</a></li>
<li>distroless - <a href="https://medium.com/@luke_perry_dev/dockerizing-with-distroless-f3b84ae10f3a">https://medium.com/@luke_perry_dev/dockerizing-with-distroless-f3b84ae10f3a</a></li>
</ul>
<h2 id="scenario">Scenario<a class="headerlink" href="#scenario" title="Permanent link">&para;</a></h2>
<ol>
<li>Install and Test Student API Application </li>
<li>Create a Basic Dockerfile</li>
<li>Create a Multistage DockerFile </li>
<li>Create a Single Stage Buildah File</li>
<li>Creat a MultiStage Buildah File</li>
<li>Push image to Dockerhub </li>
</ol>
<p><strong>Solutions</strong></p>
<details class="solve">
<summary>Solution</summary>
<p>1.Install and Test Student API Application</p>
<p>1.1 Set-up environment
  <div class="highlight"><pre><span></span><code>$ mkdir student
$ cd student
$ sudo apt-get install python3-venv 
$ python3 -m venv venv 
$ source venv/bin/activate 
$ pip install fastapi uvicorn 
$ sudo apt-get install jq
</code></pre></div></p>
<p>1.2 Create Application</p>
<div class="highlight"><pre><span></span><code>cat &lt;&lt;&#39;EOF&#39; &gt;&gt;app.py

#
from fastapi import FastAPI, HTTPException
from typing import Optional
from pydantic import BaseModel

app = FastAPI()

students = [
    {&#39;name&#39;: &#39;Student 1&#39;, &#39;age&#39;: 20},
    {&#39;name&#39;: &#39;Student 2&#39;, &#39;age&#39;: 18},
    {&#39;name&#39;: &#39;Student 3&#39;, &#39;age&#39;: 16}
]

class Student(BaseModel):
    name: str
    age: int

@app.get(&#39;/students&#39;)
def user_list(min: Optional[int] = None, max: Optional[int] = None):

    if min and max:

        filtered_students = list(
            filter(lambda student: max &gt;= student[&#39;age&#39;] &gt;= min, students)
        )

        return {&#39;students&#39;: filtered_students}

    return {&#39;students&#39;: students}

@app.get(&#39;/students/{student_id}&#39;)
def user_detail(student_id: int):
    student_check(student_id)
    return {&#39;student&#39;: students[student_id]}

@app.post(&#39;/students&#39;)
def user_add(student: Student):
    students.append(student)

    return {&#39;student&#39;: students[-1]}

@app.put(&#39;/students/{student_id}&#39;)
def user_update(student: Student, student_id: int):
    student_check(student_id)
    students[student_id].update(student)

    return {&#39;student&#39;: students[student_id]}

@app.delete(&#39;/students/{student_id}&#39;)
def user_delete(student_id: int):
    student_check(student_id)
    del students[student_id]

    return {&#39;students&#39;: students}

def student_check(student_id):
    if not students[student_id]:
        raise HTTPException(status_code=404, detail=&#39;Student Not Found&#39;)
EOF
</code></pre></div>
<p>1.3 Run application
  <div class="highlight"><pre><span></span><code>uvicorn --port 8090 app:app 

# Create the requirements.txt for next stages 
$ pip freeze &gt; requirements.txt
</code></pre></div></p>
<p>1.4 Test the API</p>
<div class="highlight"><pre><span></span><code># Get all students
$ curl http://127.0.0.1:8090/students

# Filter students based on age
$ curl &quot;http://127.0.0.1:8090/students?min=16&amp;max=18&quot;

# Get single student
$ curl http://127.0.0.1:8090/students/0T
# Add student
$ curl -X &#39;POST&#39; http://127.0.0.1:8090/students -H &#39;Content-Type: application/json&#39; -d &#39;{&quot;name&quot;:&quot;Tekton Operator&quot;, &quot;age&quot;: 99}&#39;

# update student
$ curl -X &#39;PUT&#39; http://127.0.0.1:8090/students/0 -H &#39;Content-Type: application/json&#39; -d &#39;{&quot;name&quot;:&quot;Student X&quot;, &quot;age&quot;: 18}&#39;

# Delete Student 
$curl -X &#39;DELETE&#39; http://127.0.0.1:8090/students/3
</code></pre></div>
<p>2.0 Create a Basic Dockerfile </p>
<div class="highlight"><pre><span></span><code>cat &lt;&lt;&#39;EOF&#39; &gt;&gt;Dockerfile
FROM python:3.8

# Install dependencies
COPY requirements.txt .


RUN pip install -r requirements.txt 

# Copy the application code
COPY . .

# Run the application
CMD [&quot;uvicorn&quot;, &quot;app:app&quot;, &quot;--host&quot;, &quot;0.0.0.0&quot;, &quot;--port&quot;, &quot;8090&quot;]
EOF
</code></pre></div>
<p>2.1 Build and run application</p>
<div class="highlight"><pre><span></span><code>$ docker build -t studentbook .
$ docker run -p 8090:8090 --name sb studentbook
</code></pre></div>
<p>3.0 Create a Multistage DockerFile </p>
<div class="highlight"><pre><span></span><code>cat &lt;&lt;&#39;EOF&#39; &gt;&gt;Dockerfile
# Stage 1 - Build stage
FROM python:3.10-slim AS build-env

# Copy the application code
COPY . /app
WORKDIR /app

# Install dependencies 
RUN pip install --no-cache-dir --upgrade -r requirements.txt &amp;&amp; cp $(which uvicorn) /app

# Stage 2 - Distroless container 
FROM gcr.io/distroless/python3

# Copy the built application from the build stage
COPY --from=build-env /app /app
COPY --from=build-env /usr/local/lib/python3.10/site-packages /usr/local/lib/python3.10/site-packages
ENV PYTHONPATH=/usr/local/lib/python3.10/site-packages

WORKDIR /app

# Run the application 
CMD [&quot;./uvicorn&quot;, &quot;app:app&quot;, &quot;--host&quot;, &quot;0.0.0.0&quot;, &quot;--port&quot;, &quot;8090&quot;]
EOF
</code></pre></div>
<p>3.1 Build and run application</p>
<div class="highlight"><pre><span></span><code>$ docker build -t studentbook .
$ docker run -p 8090:8090 studentbook
</code></pre></div>
<p>4.0 Create a Single Stage Buildah File </p>
<p><div class="highlight"><pre><span></span><code>cat &lt;&lt;&#39;EOF&#39; &gt;&gt;single-buildah.sh
#!/usr/bin/env bash

set -euo pipefail

# Create a new container from the python:3.8-slim image
container=$(buildah from python:3.8-slim)

# Install dependencies
buildah run &quot;$container&quot; -- pip install fastapi uvicorn

# Copy the application code
buildah copy &quot;$container&quot; . /app

# Set the working directory
buildah config --workingdir /app &quot;$container&quot;

# Set the entrypoint
buildah config --entrypoint &quot;uvicorn app:app --host 0.0.0.0 --port 8090&quot; &quot;$container&quot;

# Commit the container to an image
buildah commit &quot;$container&quot; studentbook

# Remove the container
buildah rm &quot;$container&quot;
EOF

sudo chmod +x single-buildah.sh
./single-buildah.sh

$ podman run -p 8090:8090 studentbook
</code></pre></div>
  90:8090 localhost:5001/studentbook:1.0
  <div class="highlight"><pre><span></span><code>6.0 Push student book to DockerHub

# assumes you have DockerHub account set-up

6.1 Enter docker username and password (NOTE not secure to do it this way)
</code></pre></div>
  $ docker login -u your_user_name
  <div class="highlight"><pre><span></span><code>6.2 Tag image (if not already done from above)
</code></pre></div>
  $ docker build -t studentbook
  $ docker image tag studentbook USER/studentbook:v1.0
  <div class="highlight"><pre><span></span><code>6.3 Push Image
</code></pre></div>
  $ docker image push USER/studentbook:v1.0
  $ docker push 
  ```</p>
</details>
<h2 id="additional-challenges">Additional Challenges<a class="headerlink" href="#additional-challenges" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p><strong>Security Tooling Container</strong> - Building your own security tooling container can be useful.  Using <a href="https://github.com/madhuakula/hacker-container">Hacker Container</a> as inspiration, craft your own security tooling container that you can use for future endeavors.  Some design consideration are:</p>
<ul>
<li>Conatiner should be built using a multistage process</li>
<li>Keep the container as lean as possible</li>
<li>Consider implementing a flag that will only add tools for a given a situation.  For example, you could have a light, medium, and heavy option that includes more or less tooling depending on the flag. </li>
</ul>
</li>
<li>
<p><strong>Create a multistage Buildah file</strong> - Using Buildah, create a multistage build file and deploy the studentbook app in a container. </p>
</li>
</ol>

  <hr>
<div class="md-source-file">
  <small>
    
      Last update:
      <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">January 23, 2023</span>
      
    
  </small>
</div>

              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../published/" class="md-footer__link md-footer__link--prev" aria-label="Previous: 2.Containerized Application" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              2.Containerized Application
            </div>
          </div>
        </a>
      
      
        
        <a href="../sign/" class="md-footer__link md-footer__link--next" aria-label="Next: 4.Image Signing" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              4.Image Signing
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      © Copyright Martin Harrod
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://discord.com" target="_blank" rel="noopener" title="discord.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M524.531 69.836a1.5 1.5 0 0 0-.764-.7A485.065 485.065 0 0 0 404.081 32.03a1.816 1.816 0 0 0-1.923.91 337.461 337.461 0 0 0-14.9 30.6 447.848 447.848 0 0 0-134.426 0 309.541 309.541 0 0 0-15.135-30.6 1.89 1.89 0 0 0-1.924-.91 483.689 483.689 0 0 0-119.688 37.107 1.712 1.712 0 0 0-.788.676C39.068 183.651 18.186 294.69 28.43 404.354a2.016 2.016 0 0 0 .765 1.375 487.666 487.666 0 0 0 146.825 74.189 1.9 1.9 0 0 0 2.063-.676A348.2 348.2 0 0 0 208.12 430.4a1.86 1.86 0 0 0-1.019-2.588 321.173 321.173 0 0 1-45.868-21.853 1.885 1.885 0 0 1-.185-3.126 251.047 251.047 0 0 0 9.109-7.137 1.819 1.819 0 0 1 1.9-.256c96.229 43.917 200.41 43.917 295.5 0a1.812 1.812 0 0 1 1.924.233 234.533 234.533 0 0 0 9.132 7.16 1.884 1.884 0 0 1-.162 3.126 301.407 301.407 0 0 1-45.89 21.83 1.875 1.875 0 0 0-1 2.611 391.055 391.055 0 0 0 30.014 48.815 1.864 1.864 0 0 0 2.063.7A486.048 486.048 0 0 0 610.7 405.729a1.882 1.882 0 0 0 .765-1.352c12.264-126.783-20.532-236.912-86.934-334.541ZM222.491 337.58c-28.972 0-52.844-26.587-52.844-59.239s23.409-59.241 52.844-59.241c29.665 0 53.306 26.82 52.843 59.239 0 32.654-23.41 59.241-52.843 59.241Zm195.38 0c-28.971 0-52.843-26.587-52.843-59.239s23.409-59.241 52.843-59.241c29.667 0 53.307 26.82 52.844 59.239 0 32.654-23.177 59.241-52.844 59.241Z"/></svg>
    </a>
  
    
    
    <a href="mailto:<martin.harrod@proton.me>" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="m511.6 36.86-64 415.1a32.008 32.008 0 0 1-31.65 27.147c-4.188 0-8.319-.815-12.29-2.472l-122.6-51.1-50.86 76.29C226.3 508.5 219.8 512 212.8 512c-11.5 0-20.8-9.3-20.8-20.8v-96.18c0-7.115 2.372-14.03 6.742-19.64L416 96 122.3 360.3 19.69 317.5C8.438 312.8.812 302.2.062 289.1s5.47-23.72 16.06-29.77l448-255.1c10.69-6.109 23.88-5.547 34 1.406S513.5 24.72 511.6 36.86z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://linkedin.com" target="_blank" rel="noopener" title="linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.annotate", "content.tabs.link", "navigation.indexes", "navigation.sections", "navigation.tabs", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest"], "search": "../../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.748e2769.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/tablesort/5.2.1/tablesort.min.js"></script>
      
        <script src="../../assets/javascripts/tables.js"></script>
      
    
  </body>
</html>